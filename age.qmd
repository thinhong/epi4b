# Age distribution

::: {.callout-note appearance="simple"}
Click here to download the practice data:

{{< downloadthis data/linelist_cleaned.rds dname="linelist_cleaned" label="linelist_cleaned.rds" type=light >}}
:::

Load all essential packages and data.

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(ggsci)

df <- readRDS("data/linelist_cleaned.rds")
```

## Time series stacked bar

We want to see if the age distribution changes during the epidemic. The age categories are in `age_cat`, and we will look at how they change weekly. First, we will group the onset days into weeks using `floor_date()` from the `lubridate` package.

```{r}
df$week_onset <- floor_date(df$date_onset, "week")
```

Compute the weekly percentage for each group. 

```{r}
df_plot <- df |> 
  filter(!is.na(week_onset), !is.na(age_cat)) |> 
  count(week_onset, age_cat) |> 
  group_by(week_onset) |> 
  mutate(prop = n / sum(n)) |> 
  data.frame()

# Use complete() to fill missing groups with 0
df_plot <- df_plot |> 
  complete(week_onset, age_cat, fill = list(n = 0, prop = 0))
```

Plot it with `geom_bar()`.

```{r}
#| fig-width: 6
#| fig-height: 3
#| out-width: "100%"
ggplot(df_plot, aes(x = week_onset, y = prop, fill = age_cat)) +
  geom_bar(stat = "identity") +
  scale_fill_jco() +
  theme_minimal()
```

You might want to reverse the order so that ages 0-4 are at the bottom and 70+ at the top. Do this by setting the `position` argument. Also, reverse the legend to match the new plot order.

```{r}
#| fig-width: 6
#| fig-height: 3
#| out-width: "100%"
ggplot(df_plot, aes(x = week_onset, y = prop, fill = age_cat)) +
  geom_bar(stat = "identity", position = position_stack(reverse = TRUE)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_fill_jco() +
  theme_minimal()
```

